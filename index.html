<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>Silver Bullet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Zigii Wong">
  
  
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Silver Bullet">
<meta property="og:url" content="http://wongzigii.com/index.html">
<meta property="og:site_name" content="Silver Bullet">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Silver Bullet">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="Silver Bullet" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Silver Bullet</a></h1>
    <p><a href="/"></a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/01/29/Naoto-Fukasawa/">
  <time datetime="2016-01-30T02:18:04.000Z">
    2016-01-29
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/01/29/Naoto-Fukasawa/">Naoto Fukasawa</a></h1>
  

  </header>
  
  <div class="entry">
    
      <blockquote>
<p>The end-users know all the various different parameters that will determine the appropriate solution without ever realizing it. This is why vague notions of ‘if only there were something like this’ never result in a concrete image, and also why, whenever they do find a good design, they invariably remark, ‘I’ve always wanted something like this’.</p>
<p>深澤直人</p>
</blockquote>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/01/05/Troubleshoot installing Nokorigi/">
  <time datetime="2016-01-06T03:37:14.000Z">
    2016-01-05
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/01/05/Troubleshoot installing Nokorigi/">Troubleshoot installing Nokorigi</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Troubleshoot installing Nokorigi for the dependency of rails.</p>
<pre><code><span class="attribute">ERROR</span>: <span class="string"> Error installing rails:</span>
<span class="attribute">ERROR</span>: <span class="string">Failed to build gem native extension.</span>

<span class="gherkin">current directory: /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/ext/nokogiri</span>
/Users/Wongzigii/.rvm/rubies/ruby-2.3.0/bin/ruby -r ./siteconf20160105-5281-1xpczbo.rb extconf.rb
checking if the C compiler accepts ... yes
checking if the C compiler accepts -Wno-error=unused-command-line-argument-hard-error-in-future... no
Building nokogiri using packaged libraries.
Using mini_portile version 2.0.0
checking for iconv.h... yes
checking for gzdopen() in -lz... yes
checking for iconv using --with-opt-<span class="keyword">*</span> flags... yes
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
IMPORTANT NOTICE:

Building Nokogiri with a packaged version of libxml2-2.9.2
with the following patches applied:
- 0001-Revert-Missing-initialization-for-the-catalog-module.patch
- 0002-Fix-missing-entities-after-CVE-2014-3660-fix.patch
- 0003-Stop-parsing-on-entities-boundaries-errors.patch
- 0004-Cleanup-conditional-section-error-handling.patch
- 0005-CVE-2015-1819-Enforce-the-reader-to-run-in-constant-.patch
- 0006-Another-variation-of-overflow-in-Conditional-section.patch
- 0007-Fix-an-error-in-previous-Conditional-section-patch.patch
- 0008-CVE-2015-8035-Fix-XZ-compression-support-loop.patch
- 0009-Updated-config.guess.patch
- 0010-Fix-parsering-short-unclosed-comment-uninitialized-access.patch
- 0011-Avoid-extra-processing-of-MarkupDecl-when-EOF.patch
- 0012-Avoid-processing-entities-after-encoding-conversion-.patch
- 0013-CVE-2015-7497-Avoid-an-heap-buffer-overflow-in-xmlDi.patch
- 0014-CVE-2015-5312-Another-entity-expansion-issue.patch
- 0015-Add-xmlHaltParser-to-stop-the-parser.patch
- 0016-Detect-incoherency-on-GROW.patch
- 0017-CVE-2015-7500-Fix-memory-access-error-due-to-incorre.patch
- 0018-CVE-2015-8242-Buffer-overead-with-HTML-parser-in-pus.patch

Team Nokogiri will keep on doing their best to provide security
updates in a timely manner, but if this is a concern for you and want
to use the system library instead; abort this installation process and
reinstall nokogiri as follows:

gem install nokogiri -- --use-system-libraries
    [--with-xml2-config=/path/to/xml2-config]
    [--with-xslt-config=/path/to/xslt-config]

If you are using Bundler, tell it to use the option:

bundle config build.nokogiri --use-system-libraries
bundle install

Note, however, that nokogiri is not fully compatible with arbitrary
versions of libxml2 provided by OS/package vendors.
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
Extracting libxml2-2.9.2.tar.gz into tmp/x86_64-apple-darwin15.2.0/ports/libxml2/2.9.2... OK
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0001-Revert-Missing-initialization-for-the-catalog-module.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0002-Fix-missing-entities-after-CVE-2014-3660-fix.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0003-Stop-parsing-on-entities-boundaries-errors.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0004-Cleanup-conditional-section-error-handling.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0005-CVE-2015-1819-Enforce-the-reader-to-run-in-constant-.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0006-Another-variation-of-overflow-in-Conditional-section.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0007-Fix-an-error-in-previous-Conditional-section-patch.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0008-CVE-2015-8035-Fix-XZ-compression-support-loop.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0009-Updated-config.guess.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0010-Fix-parsering-short-unclosed-comment-uninitialized-access.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0011-Avoid-extra-processing-of-MarkupDecl-when-EOF.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0012-Avoid-processing-entities-after-encoding-conversion-.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0013-CVE-2015-7497-Avoid-an-heap-buffer-overflow-in-xmlDi.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0014-CVE-2015-5312-Another-entity-expansion-issue.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0015-Add-xmlHaltParser-to-stop-the-parser.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0016-Detect-incoherency-on-GROW.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0017-CVE-2015-7500-Fix-memory-access-error-due-to-incorre.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxml2/0018-CVE-2015-8242-Buffer-overead-with-HTML-parser-in-pus.patch... OK</span>
Running 'configure' for libxml2 2.9.2... OK
Running 'compile' for libxml2 2.9.2... OK
Running 'install' for libxml2 2.9.2... OK
Activating libxml2 2.9.2 (from /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/ports/x86_64-apple-darwin15.2.0/libxml2/2.9.2)...</span>
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
IMPORTANT NOTICE:

Building Nokogiri with a packaged version of libxslt-1.1.28
with the following patches applied:
- 0001-Adding-doc-update-related-to-1.1.28.patch
- 0002-Fix-a-couple-of-places-where-f-printf-parameters-wer.patch
- 0003-Initialize-pseudo-random-number-generator-with-curre.patch
- 0004-EXSLT-function-str-replace-is-broken-as-is.patch
- 0006-Fix-str-padding-to-work-with-UTF-8-strings.patch
- 0007-Separate-function-for-predicate-matching-in-patterns.patch
- 0008-Fix-direct-pattern-matching.patch
- 0009-Fix-certain-patterns-with-predicates.patch
- 0010-Fix-handling-of-UTF-8-strings-in-EXSLT-crypto-module.patch
- 0013-Memory-leak-in-xsltCompileIdKeyPattern-error-path.patch
- 0014-Fix-for-bug-436589.patch
- 0015-Fix-mkdir-for-mingw.patch
- 0016-Fix-for-type-confusion-in-preprocessing-attributes.patch
- 0017-Updated-config.guess.patch

Team Nokogiri will keep on doing their best to provide security
updates in a timely manner, but if this is a concern for you and want
to use the system library instead; abort this installation process and
reinstall nokogiri as follows:

gem install nokogiri -- --use-system-libraries
    [--with-xml2-config=/path/to/xml2-config]
    [--with-xslt-config=/path/to/xslt-config]

If you are using Bundler, tell it to use the option:

bundle config build.nokogiri --use-system-libraries
bundle install
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
Extracting libxslt-1.1.28.tar.gz into tmp/x86_64-apple-darwin15.2.0/ports/libxslt/1.1.28... OK
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0001-Adding-doc-update-related-to-1.1.28.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0002-Fix-a-couple-of-places-where-f-printf-parameters-wer.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0003-Initialize-pseudo-random-number-generator-with-curre.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0004-EXSLT-function-str-replace-is-broken-as-is.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0006-Fix-str-padding-to-work-with-UTF-8-strings.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0007-Separate-function-for-predicate-matching-in-patterns.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0008-Fix-direct-pattern-matching.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0009-Fix-certain-patterns-with-predicates.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0010-Fix-handling-of-UTF-8-strings-in-EXSLT-crypto-module.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0013-Memory-leak-in-xsltCompileIdKeyPattern-error-path.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0014-Fix-for-bug-436589.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0015-Fix-mkdir-for-mingw.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0016-Fix-for-type-confusion-in-preprocessing-attributes.patch... OK</span>
Running git apply with /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/patches/libxslt/0017-Updated-config.guess.patch... OK</span>
Running 'configure' for libxslt 1.1.28... ERROR, review '/Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1/ext/nokogiri/tmp/x86_64-apple-darwin15.2.0/ports/libxslt/1.1.28/configure.log' to see what happened. Last lines are:</span>
========================================================================
 Darwin Kernel Version 15.2.0: Fri Nov 13 19:56:56 PST 2015; root:xnu-3248.20.55~2/RELEASE_X86_64
Kernel configured for up to 8 processors.
4 processors are physically available.
8 processors are logically available.
Processor type: x86_64h (Intel x86-64h Haswell)
Processors active: 0 1 2 3 4 5 6 7
Primary memory available: 16.00 gigabytes
Default processor set: 376 tasks, 1947 threads, 8 processors
Load average: 1.84, Mach factor: 6.14
/bin/universe          =
/usr/bin/arch -k       =
/bin/arch              =
/usr/bin/oslevel       =
/usr/convex/getsysinfo =

UNAME_MACHINE = x86_64
UNAME_RELEASE = 15.2.0
UNAME_SYSTEM  = Darwin
UNAME_VERSION = Darwin Kernel Version 15.2.0: Fri Nov 13 19:56:56 PST 2015; root:xnu-3248.20.55~2/RELEASE_X86_64
configure: error: cannot guess build type; you must specify one
========================================================================
<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> extconf.rb failed <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>
Could not create Makefile due to some reason, probably lack of necessary
libraries and/or headers.  Check the mkmf.log file for more details.  You may
need configuration options.

Provided configuration options:
--with-opt-dir
--with-opt-include
--without-opt-include=${opt-dir}/include
--with-opt-lib
--without-opt-lib=${opt-dir}/lib
--with-make-prog
--without-make-prog
--srcdir=.
--curdir
--ruby=/Users/Wongzigii/.rvm/rubies/ruby-2.3.0/bin/$(RUBY_BASE_NAME)
--help
--clean
--use-system-libraries
--enable-static
--disable-static
--with-zlib-dir
--without-zlib-dir
--with-zlib-include
--without-zlib-include=${zlib-dir}/include
--with-zlib-lib
--without-zlib-lib=${zlib-dir}/lib
--enable-cross-build
--disable-cross-build
/Users/Wongzigii/.rvm/rubies/ruby-2.3.0/lib/ruby/gems/2.3.0/gems/mini_portile2-2.0.0/lib/mini_portile2/mini_portile.rb:366:in `block in execute': Failed to complete configure task (RuntimeError)
from /Users/Wongzigii/.rvm/rubies/ruby-2.3.0/lib/ruby/gems/2.3.0/gems/mini_portile2-2.0.0/lib/mini_portile2/mini_portile.rb:337:in `chdir'
from /Users/Wongzigii/.rvm/rubies/ruby-2.3.0/lib/ruby/gems/2.3.0/gems/mini_portile2-2.0.0/lib/mini_portile2/mini_portile.rb:337:in `execute'
from /Users/Wongzigii/.rvm/rubies/ruby-2.3.0/lib/ruby/gems/2.3.0/gems/mini_portile2-2.0.0/lib/mini_portile2/mini_portile.rb:106:in `configure'
from /Users/Wongzigii/.rvm/rubies/ruby-2.3.0/lib/ruby/gems/2.3.0/gems/mini_portile2-2.0.0/lib/mini_portile2/mini_portile.rb:149:in `cook'
from extconf.rb:289:in `block (2 levels) in process_recipe'
from extconf.rb:182:in `block in chdir_for_build'
from extconf.rb:181:in `chdir'
from extconf.rb:181:in `chdir_for_build'
from extconf.rb:288:in `block in process_recipe'
from extconf.rb:187:in `tap'
from extconf.rb:187:in `process_recipe'
from extconf.rb:490:in `<span class="variable">&lt;main&gt;</span>'

To see why this extension failed to compile, please check the mkmf.log which can be found here:

  /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/extensions/x86_64-darwin-15/2.3.0/nokogiri-1.6.7.1/mkmf.log</span>

extconf failed, exit code 1

Gem files will remain installed in /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/gems/nokogiri-1.6.7.1 for inspection.</span>
Results logged to /Users/Wongzigii/.rvm/gems/ruby-2.3.0<span class="comment">@rails4.2/extensions/x86_64-darwin-15/2.3.0/nokogiri-1.6.7.1/gem_make.out</span></span>
</code></pre><p><strong>The Problem:</strong></p>
<blockquote>
<p>For some reason Apple’s Yosemite version of OSX does not have a system accessible installation of libxml2.  Nokogiri requires this in order to compile and luckily Xcode has a version of libxml2 bundled with it — we just need to specify it when installing the gem.  It’s important to get Nokogiri installed correctly because as of right now Rails 4.2.1.rc4 automatically attempts to install it and you will feel pain.</p>
</blockquote>
<p><strong>Solved:</strong></p>
<pre><code>gem install nokogiri -- --use-system-libraries=<span class="keyword">true</span> --with-xml2-<span class="keyword">include</span>=<span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/</span>MacOSX.platform<span class="regexp">/Developer/</span>SDKs<span class="regexp">/MacOSX10.11.sdk/u</span>sr<span class="regexp">/include/</span>libxml2<span class="regexp">/</span>
</code></pre><p>Cheers!</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/05/29/A-simple-Makefile-Tutorial/">
  <time datetime="2015-05-30T06:57:19.000Z">
    2015-05-29
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/05/29/A-simple-Makefile-Tutorial/">A Simple Makefile Tutorial</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><a href="http://www.cs.colby.edu/maxwell/courses/tutorials/maketutor/" target="_blank" rel="external">Original post</a></p>
<p>Makefiles are a simple way to organize code compilation. This tutorial does not even scratch the surface of what is possible using make, but is intended as a starters guide so that you can quickly and easily create your own makefiles for small to medium-sized projects.</p>
<p>A Simple Example</p>
<p>Let’s start off with the following three files, hellomake.c, hellofunc.c, and hellomake.h, which would represent a typical main program, some functional code in a separate file, and an include file, respectively.</p>
<h2 id="hellomake-c">hellomake.c</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;hellomake.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// call a function in another file</span></span><br><span class="line">  myPrintHelloMake();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##hellofunc.c</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;hellomake.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myPrintHelloMake</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hello makefiles!\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##hellomake.h</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">example include file</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myPrintHelloMake</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Normally, you would compile this collection of code by executing the following command:</p>
<p><code>gcc -o hellomake hellomake.c hellofunc.c -I</code></p>
<p>This compiles the two .c files and names the executable hellomake. The -I. is included so that gcc will look in the current directory (.) for the include file hellomake.h. Without a makefile, the typical approach to the test/modify/debug cycle is to use the up arrow in a terminal to go back to your last compile command so you don’t have to type it each time, especially once you’ve added a few more .c files to the mix.</p>
<p>Unfortunately, this approach to compilation has two downfalls. First, if you lose the compile command or switch computers you have to retype it from scratch, which is inefficient at best. Second, if you are only making changes to one .c file, recompiling all of them every time is also time-consuming and inefficient. So, it’s time to see what we can do with a makefile.</p>
<p>The simplest makefile you could create would look something like:</p>
<p>###Makefile 1</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hellomake: hellomake<span class="class">.c</span> hellofunc<span class="class">.c</span></span><br><span class="line">     gcc -o hellomake hellomake<span class="class">.c</span> hellofunc<span class="class">.c</span> -I.</span><br></pre></td></tr></table></figure>
<p>If you put this rule into a file called Makefile or makefile and then type make on the command line it will execute the compile command as you have written it in the makefile. Note that make with no arguments executes the first rule in the file. Furthermore, by putting the list of files on which the command depends on the first line after the :, make knows that the rule hellomake needs to be executed if any of those files change. Immediately, you have solved problem #1 and can avoid using the up arrow repeatedly, looking for your last compile command. However, the system is still not being efficient in terms of compiling only the latest changes.</p>
<p>One very important thing to note is that there is a tab before the gcc command in the makefile. There must be a tab at the beginning of any command, and make will not be happy if it’s not there.</p>
<p>In order to be a bit more efficient, let’s try the following:</p>
<p>###Makefile 2</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">CFLAGS=-I.</span><br><span class="line"></span><br><span class="line">hellomake: hellomake<span class="class">.o</span> hellofunc<span class="class">.o</span></span><br><span class="line">     $(CC) -o hellomake hellomake<span class="class">.o</span> hellofunc<span class="class">.o</span> -I.</span><br></pre></td></tr></table></figure>
<p>So now we’ve defined some constants CC and CFLAGS. It turns out these are special constants that communicate to make how we want to compile the files hellomake.c and hellofunc.c. In particular, the macro CC is the C compiler to use, and CFLAGS is the list of flags to pass to the compilation command. By putting the object files–hellomake.o and hellofunc.o–in the dependency list and in the rule, make knows it must first compile the .c versions individually, and then build the executable hellomake.</p>
<p>Using this form of makefile is sufficient for most small scale projects. However, there is one thing missing: dependency on the include files. If you were to make a change to hellomake.h, for example, make would not recompile the .c files, even though they needed to be. In order to fix this, we need to tell make that all .c files depend on certain .h files. We can do this by writing a simple rule and adding it to the makefile.</p>
<p>###Makefile 3</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">CFLAGS=-I.</span><br><span class="line">DEPS = hellomake.h</span><br><span class="line"></span><br><span class="line"><span class="variable">%.</span>o: <span class="variable">%.</span>c <span class="variable">$(</span>DEPS)</span><br><span class="line">	<span class="variable">$(</span>CC) -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span> <span class="variable">$(</span>CFLAGS)</span><br><span class="line"></span><br><span class="line">hellomake: hellomake.o hellofunc.o </span><br><span class="line">	gcc -o hellomake hellomake.o hellofunc.o -I.</span><br></pre></td></tr></table></figure>
<p>This addition first creates the macro DEPS, which is the set of .h files on which the .c files depend. Then we define a rule that applies to all files ending in the .o suffix. The rule says that the .o file depends upon the .c version of the file and the .h files included in the DEPS macro. The rule then says that to generate the .o file, make needs to compile the .c file using the compiler defined in the CC macro. The -c flag says to generate the object file, the -o $@ says to put the output of the compilation in the file named on the left side of the :, the $&lt; is the first item in the dependencies list, and the CFLAGS macro is defined as above.</p>
<p>As a final simplification, let’s use the special macros $@ and $^, which are the left and right sides of the :, respectively, to make the overall compilation rule more general. In the example below, all of the include files should be listed as part of the macro DEPS, and all of the object files should be listed as part of the macro OBJ.</p>
<p>###Makefile 4</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">CFLAGS=-I.</span><br><span class="line">DEPS = hellomake.h</span><br><span class="line">OBJ = hellomake.o hellofunc.o </span><br><span class="line"></span><br><span class="line"><span class="variable">%.</span>o: <span class="variable">%.</span>c <span class="variable">$(</span>DEPS)</span><br><span class="line">	<span class="variable">$(</span>CC) -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span> <span class="variable">$(</span>CFLAGS)</span><br><span class="line"></span><br><span class="line">hellomake: <span class="variable">$(</span>OBJ)</span><br><span class="line">	gcc -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(</span>CFLAGS)</span><br></pre></td></tr></table></figure>
<p>So what if we want to start putting our .h files in an include directory, our source code in a src directory, and some local libraries in a lib directory? Also, can we somehow hide those annoying .o files that hang around all over the place? The answer, of course, is yes. The following makefile defines paths to the include and lib directories, and places the object files in an obj subdirectory within the src directory. It also has a macro defined for any libraries you want to include, such as the math library -lm. This makefile should be located in the src directory. Note that it also includes a rule for cleaning up your source and object directories if you type make clean. The .PHONY rule keeps make from doing something with a file named clean.</p>
<p>###Makefile 5</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">IDIR</span> =../<span class="keyword">include</span></span><br><span class="line"><span class="constant">CC</span>=gcc</span><br><span class="line"><span class="constant">CFLAGS</span>=-<span class="constant">I</span><span class="variable">$(</span><span class="constant">IDIR</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">ODIR</span>=obj</span><br><span class="line"><span class="constant">LDIR</span> =../<span class="class"><span class="keyword">lib</span></span></span><br><span class="line"></span><br><span class="line"><span class="constant">LIBS</span>=-lm</span><br><span class="line"></span><br><span class="line">_DEPS = hellomake.h</span><br><span class="line"><span class="constant">DEPS</span> = <span class="variable">$(</span>patsubst %,<span class="variable">$(</span><span class="constant">IDIR</span>)/%,<span class="variable">$(</span>_DEPS))</span><br><span class="line"></span><br><span class="line">_OBJ = hellomake.o hellofunc.o </span><br><span class="line"><span class="constant">OBJ</span> = <span class="variable">$(</span>patsubst %,<span class="variable">$(</span><span class="constant">ODIR</span>)/%,<span class="variable">$(</span>_OBJ))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$(</span><span class="constant">ODIR</span>)/%.<span class="symbol">o:</span> %.c <span class="variable">$(</span><span class="constant">DEPS</span>)</span><br><span class="line">	<span class="variable">$(</span><span class="constant">CC</span>) -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span> <span class="variable">$(</span><span class="constant">CFLAGS</span>)</span><br><span class="line"></span><br><span class="line"><span class="symbol">hellomake:</span> <span class="variable">$(</span><span class="constant">OBJ</span>)</span><br><span class="line">	gcc -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(</span><span class="constant">CFLAGS</span>) <span class="variable">$(</span><span class="constant">LIBS</span>)</span><br><span class="line"></span><br><span class="line">.<span class="constant">PHONY</span>: clean</span><br><span class="line"></span><br><span class="line"><span class="symbol">clean:</span></span><br><span class="line">	rm -f <span class="variable">$(</span><span class="constant">ODIR</span>)/*.o *~ core <span class="variable">$(</span><span class="constant">INCDIR</span>)/*~</span><br></pre></td></tr></table></figure>
<p>So now you have a perfectly good makefile that you can modify to manage small and medium-sized software projects. You can add multiple rules to a makefile; you can even create rules that call other rules. For more information on makefiles and the make function, check out the <a href="http://www.gnu.org/software/make/manual/make.html" target="_blank" rel="external">GNU Make Manual</a>, which will tell you more than you ever wanted to know (really).</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/04/17/What-is-a-meta-class-in-Objective-C/">
  <time datetime="2015-04-17T17:51:43.000Z">
    2015-04-17
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/04/17/What-is-a-meta-class-in-Objective-C/">MetaClass</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html" target="_blank" rel="external">From Cocoa with Love</a></p>
<p>在这篇文章中，我们会看到一个在 Objective-C 中很陌生的概念 – meta-class。Objective-C 里面每个类都有它自己的 meta-class，但是你很少会注意到你使用了它。我们在开头会学习怎样在 runtime 创建一个类，通过创建的 “class pair”，我会解释什么是 meta-class，然后深入研究它对于 Objective-C 中对象和类的意义。</p>
<h3 id="在_Runtime_创建一个类">在 Runtime 创建一个类</h3><p>下面的代码会在 runtime 创建一个 <code>NSError</code> 的子类，并在其中增加一个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class newClass =</span><br><span class="line">    objc_allocateClassPair([<span class="built_in">NSError</span> class], <span class="string">"RuntimeErrorSubclass"</span>, <span class="number">0</span>);</span><br><span class="line">class_addMethod(newClass, <span class="keyword">@selector</span>(report), (IMP)ReportFunction, <span class="string">"v@:"</span>);</span><br><span class="line">objc_registerClassPair(newClass);</span><br></pre></td></tr></table></figure>
<p>这个方法使用一个叫 <code>ReportFunction</code> 的函数作为它的实现，它的定义如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ReportFunction(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"This object is %p."</span>, <span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Class is %@, and super is %@."</span>, [<span class="keyword">self</span> class], [<span class="keyword">self</span> superclass]);</span><br><span class="line"> </span><br><span class="line">    Class currentClass = [<span class="keyword">self</span> class];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Following the isa pointer %d times gives %p"</span>, i, currentClass);</span><br><span class="line">        currentClass = object_getClass(currentClass);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSObject's class is %p"</span>, [<span class="built_in">NSObject</span> class]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSObject's meta class is %p"</span>, object_getClass([<span class="built_in">NSObject</span> class]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表面上看这些都很简单。在 runtime 创建一个类只需三个步骤：</p>
<ol>
<li>为 <code>class pair</code> 开辟内存，（使用objc_allocateClassPair）。</li>
<li>添加方法或成员变量到这个类中（通过 class_addMethod 增加一个方法）。</li>
<li>注册这个类，以便它能使用(使用 objc_registerClassPair)。</li>
</ol>
<p>然而，有一个很关键的问题是：<code>class pair</code> 是什么东西？<code>objc_allocateClassPair</code> 函数只返回一个值：the class。那另外一半呢？</p>
<p>我相信你已经猜到了，另一半就是 meta-class，在解释这个东西是什么和你为什么需要这个东西之前，还需要先了解一下对象和类的背景知识。</p>
<h3 id="怎么样的数据类型才能成为对象？">怎么样的数据类型才能成为对象？</h3><p>每个对象都有它自己的类。这是面向对象的基本概念，但是在 Objective-C 中，数据结构都有它自己的类。含有一个指针且该指针可以正确指向类的数据结构，都可以称为对象。</p>
<p>在 Objective-C 中，对象的类是由一个叫 <code>isa</code> 的指针决定的，<code>isa</code> 指针指向对象所属的类（Class）。</p>
<blockquote>
<p>译者注：实际上在 Runtime 这篇文章中我们已经一窥 Objective-C 中最基本的定义：</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125; *<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<p>所有以指针开始并指向 Class 结构体的数据结构都可以看成是 objc_object。</p>
<p>而对象在 Objective-C 中最重要的特点就是你可以发送消息给它们：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">@"stringValue"</span></span><br><span class="line">    writeToFile:<span class="string">@"/file.txt"</span> atomically:<span class="literal">YES</span> encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>你向对象发送一个消息，runtime 会顺着对象的 isa 指针来获得对象所属的 Class。这个 Class 包含了很多定义的的 Method，还包含一个指向 superclass 的指针，来寻找继承自父类的方法。当你发送消息的时候，首先，runtime 会在所属 Class 的 Method 中查找方法，如果找不到，就会去 superclass 中查找父类的方法。如果找到了，runtime 会根据这个方法调用实现函数（IMP）。</p>
<h3 id="什么是_meta-class？">什么是 meta-class？</h3><p>现在，正如你所了解那样，一个 Class 在 Objective-C 中也算一个对象。这意味着你可以向 Class 发送消息。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSStringEncoding</span> defaultStringEncoding = [<span class="built_in">NSString</span> defaultStringEncoding];</span><br></pre></td></tr></table></figure>
<p>在这个例子中，<code>defaultStringEncoding</code> 类方法被发送到 <code>NSString</code> 类。</p>
<p>由于 Objective-C 里所有 Class 都是一个对象，因此，Class 结构体的第一项必须是一个指向 isa 的指针，从而符合上面 objc_object 结构体的定义，而第二项必须是一个指向 superclass （或者 nil，对于基本的类）的指针。</p>
<p>一个 Class 的定义会因你所使用的 runtime 的版本而异，但有一点不变的是，它们第一项都是一个 isa 指针，然后紧接着是 superclass 指针。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">    Class super_class;</span><br><span class="line">    <span class="comment">/* followed by runtime specific details... */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为了调用 Class 里的方法（这里指的是类方法），isa 指针必须指向一个 Class 结构体，这个 Class 结构体必须包含那些我们可以调用的方法列表。</p>
<blockquote>
<p>注：这就像上面提到过的，对象为了调用 Class 里的实例方法，Class 里必须包含这些自定义的方法，只不过这里不是对象，而是 Class，因为 Class 也是一个对象</p>
</blockquote>
<p>这就要引入一个关于 meta-class 的概念：meta-class 是一个 Class 对象的类。</p>
<p>简单说就是：</p>
<ul>
<li>当你向对象发送消息，是在这个对象的类的方法列表中寻找。（实例方法）</li>
<li>当你向类（Class）发送消息，是在这个 Class 的 meta-class 的方法列表中寻找。（类方法）</li>
</ul>
<p>meta-class 是必不可少的，因为它储存了这个类的类方法。由于每个类都有独一无二的类方法，所以每个类都有独一无二的 meta-class。</p>
<h3 id="meta-class_的类是什么?">meta-class 的类是什么?</h3><p>meta-class，像前面的 Class，也是一个对象。这意味着你也可以向它发送消息。同样，它也必须要有一个类。</p>
<p>所有的 meta-class 使用 NSObject 的 meta-class 作为它的类，因此 isa 指针都指向 NSObject 的 meta-class。那 NSObject 的 meta-class 的 isa 指针指向哪呢？ 它自己。</p>
<p>说的更拗口一点就是，根元类把它自己的基类设置成了super_class。</p>
<p>在这样的继承体系下，所有实例、类以及元类（meta class）都继承自一个基类。</p>
<p>这意味着对于继承于 NSObject 的所有实例、类和元类，他们可以使用 NSObject 的所有实例方法，类和元类可以使用 NSObject 的所有类方法。</p>
<p><img src="http://www.sealiesoftware.com/blog/class%20diagram.pdf" alt=""></p>
<h3 id="实验">实验</h3><p>为了验证，让我们看看我在文章开始写的 ReportFunction 函数的输出。这个函数的目的是跟随 isa 指针并打印出它的路径。</p>
<p>为了运行 ReportFunction，我们需要创建一个动态实例来创建类调用 report 方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> instanceOfNewClass =</span><br><span class="line">    [[newClass alloc] initWithDomain:<span class="string">@"someDomain"</span> code:<span class="number">0</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">[instanceOfNewClass performSelector:<span class="keyword">@selector</span>(report)];</span><br><span class="line">[instanceOfNewClass release];</span><br></pre></td></tr></table></figure>
<p>这里没有声明 report 方法，但我使用 performSelector: 调用它，所以编译器不会给出警告。<br>然后ReportFunction函数会沿着isa进行检索，来告诉我们 class，meta-class 以及meta-class 的 class 是什么样的情况：</p>
<blockquote>
<p>如何获取对象的类：在文章的开头部分，ReportFunction 函数通过 object_getClass 方法来跟踪 isa 指针，因为 isa 指针是类的保护成员（你不能直接接收其他对象的 isa 指针）。ReportFunction 不使用类方法，因为在类对象里调用类方法不能返回元类，它会再次返回这个类（因此 [NSString class] 会返回 NSString 类而不是 NSString 的 meta-class）。</p>
</blockquote>
<p>输出（省略了NSLog前缀）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">This object is 0x10010c810.</span><br><span class="line">Class is RuntimeErrorSubclass, and super is NSError.</span><br><span class="line">Following the isa pointer 1 times gives 0x10010c600</span><br><span class="line">Following the isa pointer 2 times gives 0x10010c630</span><br><span class="line">Following the isa pointer 3 times gives 0x7fff71038480</span><br><span class="line">Following the isa pointer 4 times gives 0x7fff71038480</span><br><span class="line">NSObject's class is 0x7fff710384a8</span><br><span class="line">NSObject's meta class is 0x7fff71038480</span><br></pre></td></tr></table></figure>
<p>观察 isa 经过的地址的值：</p>
<p>对象的地址是 0x10010c810.<br>类的地址是 0x10010c600.<br>元类的地址是 0x10010c630.<br>根元类（ NSObject 的元类）的地址是 0x7fff71038480.<br>NSObject 元类的类是它本身.<br>这些地址的值并不重要，重要的是它们说明了文中讨论的从类到 meta-class 到 NSObject 的 meta-class 的整个流程。</p>
<h3 id="尾声">尾声</h3><p>元类是 Class 对象的类。每个类（Class）都有自己独一无二的 meta-class（每个类都有自己第一无二的方法列表）。这意味着所有的类对象都不同。</p>
<p>元类总是会确保类对象和基类的所有实例和类方法。对于从 NSObject 继承下来的类，这意味着所有的 NSObject 实例和 protocol 方法在所有的类（和 meta-class ）中都可以使用。</p>
<p>所有的 meta-class 使用基类的 meta-class 作为自己的基类，对于顶层基类的 meta-class 也是一样，只是它指向自己而已。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/04/15/Hackers-and-Painters/">
  <time datetime="2015-04-16T00:47:23.000Z">
    2015-04-15
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/04/15/Hackers-and-Painters/">Hackers and Painters</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>上个周末泡了一整天图书馆，看完了 <em>Hackers and Painters</em>，<em>Paul Graham</em> 讲了他的传奇故事，记得以前看 SICP 的时候开始知道 Lisp 这门语言，看见如此 funky 的语法，心想：天啊，而看完这本书后像被安利了一样，想去了解这个充满（）的语言。</p>
<p>有几个地方让我突然眼前一亮：</p>
<blockquote>
<p>小孩子的大脑就是我们所有”不能说的话”的一面反射镜。我们似乎认定，孩子的思想应当是光明纯洁的。为了保证孩子不受外界“不良”思想的影响，我们对那些思想进行消毒和屏蔽，把世界描述成光明的样子，向孩子们灌输，将他们的心灵塑造成我们想象中的样子。</p>
<p>小孩子说脏话就是一个很好的切入点，你可以从这个小小的侧面来思考这个问题。我的许多朋友现在都开始为人父母了。他们一个个都变得非常小心，不在孩子面前使用 “Fuck”, “shit” 这样的脏话，以免孩子学会这些词。但是，这些词是日常语言的一部分，成年人一天到晚都在用。所以，孩子从家长那里得到一个错误的印象，以为它们是没人用的。为什么家长要这样伪装呢？因为他们觉得孩子不应该知道成年人语言的所以内容，只需知道一部分适合儿童的词就行了。我们喜欢孩子们看上去天真无邪。</p>
</blockquote>
<p>然后注释里写着：</p>
<blockquote>
<p>很快，孩子就会从朋友那里知道这些词。但是他们明白，不能在大人面前使用，所以，没过多久，一切就变得有点像讽刺剧了。家长在外使用这些词，回家后就不用，孩子在外也使用这些词，回家后也不用。双方见面，就像演戏一样。</p>
</blockquote>
<p>实话说，这本书让我喜欢上了读注释。:)</p>
<blockquote>
<p>著名散文家E.B.怀特说过，“最好的文字来自不停的修改”。所有优秀作家都知道这一点，它对软件开发也适用。设计一样东西，最重要的一点就是要经常“再设计”，编程尤其如此，再多的修改都不过分。</p>
</blockquote>
<p>还有一些现在才明白的魔兽世界里的彩蛋：</p>
<blockquote>
<p>在心里无所不想，但是不一定要说出来。我就鼓励自己在心里默默思考那些最无法无天的想法。你的思想是一个地下组织，绝不要把那里发生的事情一股脑说给外人说。“格斗俱乐部” 的第一条规则，就是不要提到格斗俱乐部。[^1]</p>
</blockquote>
<p>周末愉快！</p>
<p>[^1]: 《格斗俱乐部》（Fight Club）是1999年的美国电影，讲述了一个地下组织发起人的故事。在电影中，加入“格斗俱乐部”的第一条规则就是不得谈论格斗俱乐部。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/02/01/void-initialize-vs-void-load/">
  <time datetime="2015-02-02T02:29:08.000Z">
    2015-02-01
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/02/01/void-initialize-vs-void-load/">Initialize VS Load</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><a href="http://developer.apple.com/library/ios/#documentation/Cocoa/Reference/Foundation/Classes/NSObject_Class/Reference/Reference.html" target="_blank" rel="external">NSObject Class Reference</a></p>
<p>在一个类被使用之前，我们可以利用这两个方法对类做一些预处理的工作。例如将这个类自动把自己的类名保存到一个数组中。</p>
<h2 id="+_(void)_initialize">+ (void) initialize</h2><blockquote>
<p>The runtime sends initialize to each class in a program exactly one time just before the class, or any class that inherits from it, is sent its first message from within the program. (Thus the method may never be invoked if the class is not used.) The runtime sends the initialize message to classes in a thread-safe manner. Superclasses receive this message before their subclasses.</p>
</blockquote>
<h2 id="+_(void)_load">+ (void) load</h2><blockquote>
<p>The load message is sent to classes and categories that are both dynamically loaded and statically linked, but only if the newly loaded class or category implements a method that can respond.</p>
<p>The order of initialization is as follows:</p>
<p>All initializers in any framework you link to.</p>
<p>All +load methods in your image.</p>
<p>All C++ static initializers and C/C++ <em>attribute</em> (constructor) functions in your image.&gt;<br>All initializers in frameworks that link to you.<br>In addition:</p>
<p>A class’s +load method is called after all of its superclasses’ +load methods.</p>
<p>A category +load method is called after the class’s own +load method.</p>
<p>In a custom implementation of load you can therefore safely message other unrelated classes from the same image, but any load methods implemented by those classes may not have run yet.</p>
</blockquote>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/10/Property-declarations/">
  <time datetime="2015-01-11T07:55:06.000Z">
    2015-01-10
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/10/Property-declarations/">Variable Qualifiers</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>LLVM 在 3.1 以后引入了四个 <code>Lifetime Qualifiers</code>， 它们分别是 _autoreleasing，<strong>strong， </strong>unsafe_untained 还有 <strong>weak。<br> 其中 </strong>weak 只在 ARC 下才存在，而其他三个仍然可以在 MRC 下看到它们。</p>
<blockquote>
<ul>
<li>__strong is the default. An object remains “alive” as long as there is a strong pointer to it.</li>
<li>__weak specifies a reference that does not keep the referenced object alive. A weak reference is set to nil when there are no strong references to the object.</li>
<li>__unsafe_unretained specifies a reference that does not keep the referenced object alive and is not set to nil when there are no strong references to the object. If the object it references is deallocated, the pointer is left dangling.</li>
<li>__autoreleasing is used to denote arguments that are passed by reference (id *) and are autoreleased on return.</li>
</ul>
</blockquote>
<h3 id="__strong"><code>__strong</code></h3><p> 在 ARC 下，所有的指针都会默认为 <code>__strong</code>. 也就是说当指针指向一个对象时，这个对象的 retain count 就会加 1。当超出作用域或者指针被赋值后，编译器会自动为 <code>__strong</code> 修饰的对象指针添加 release。</p>
<h3 id="__weak_and___unsafe_unretained"><code>__weak</code> and <code>__unsafe_unretained</code></h3><p> 为了解决这个问题，<code>__unsafe_unretained</code> 和 <code>__weak</code> 诞生了。最常见的是当你声明一个 delegate 的时候，你需要将它的类型声明为 <code>weak</code> 或者 <code>unsafe_unretained</code> (assign 在这里相当于 <code>unsafe_unretained</code>)。在实例变量前面标记为 <code>__weak</code> 或者 <code>__unsafe_unretained</code> 。这样，delegate 的实例变量仍然指向第一个对象，但是不会被 retain，从而避免了 retain cycle。</p>
<p> 除了 delegate 之外，也可以用来避免其他代码的 retain cycle。而 Leaks Instrument 里面已经可以检查是否有 retain cycle 所导致的 memory leak 了。</p>
<p>####<code>__unsafe_unretained</code> 和 <code>__weak</code> 的区别</p>
<p>对于 <code>__weak</code>，当对象销毁后指针会被设为 nil， 这个做法使得指针的使用更安全。而正如它的名字那样，<code>__unsafe_unretained</code> 仍然会指向销毁对象的地址，顾名思义这是 unsafe 的。</p>
<p>值得注意的是：</p>
<blockquote>
<p>__weak is only supported for iOS 5.0 and Lion as deployment targets.</p>
</blockquote>
<h3 id="__autoreleasing"><code>__autoreleasing</code></h3><p>将对象指向自动释放池，编译器会自动计算 retain count，并且释放内存。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">id</span>)array </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> [[<span class="built_in">NSMutableArray</span> alloc] init]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我发现这个修饰符一般用在方法里面，因为你需要在消息的作用域里拥有这个对象，但是你又不能在消息执行完之前把它释放掉，因此把它交给 autoreleasepool，在消息执行完后，再由自动释放池释放。</p>
<p><code>Variable Qualifiers</code> 的格式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyClass * __<span class="keyword">weak</span> myWeakReference;</span><br><span class="line">MyClass * __unsafe_unretained myUnsafeReference;</span><br></pre></td></tr></table></figure>
<p>注意：如果你这像下面那样使用 <code>__weak</code>，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * __<span class="keyword">weak</span> string = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"First Name: %@"</span>, [<span class="keyword">self</span> firstName]];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"string: %@"</span>, string);</span><br></pre></td></tr></table></figure>
<p>编译器会警告你：<code>Assigning retained object to weak variable; object will be released after assignment.</code> 当你 init 完这个对象后，由于前面是 __weak 修饰符，<code>string</code> 会马上被 dealloc，因为这时候没有其他强引用指向这个对象。</p>
<p>还有一个需要注意的地方，就是将对象传递给消息：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"><span class="built_in">BOOL</span> OK = [myObject performOperationWithError:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (!OK) &#123;</span><br><span class="line">    <span class="comment">// Report the error.</span></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>实际上，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> * __<span class="keyword">strong</span> e;</span><br></pre></td></tr></table></figure>
<p>并且（上面说过的作为参数会加一个 <code>__autoreleasing</code> 修饰符）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">BOOL</span>)performOperationWithError:(<span class="built_in">NSError</span> * __autoreleasing *)error;</span><br></pre></td></tr></table></figure>
<p>所以编译器实际上会重写成这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> * __<span class="keyword">strong</span> error;</span><br><span class="line"><span class="built_in">NSError</span> * __autoreleasing tmp = error;</span><br><span class="line"><span class="built_in">BOOL</span> OK = [myObject performOperationWithError:&amp;tmp];</span><br><span class="line">error = tmp;</span><br><span class="line"><span class="keyword">if</span> (!OK) &#123;</span><br><span class="line">    <span class="comment">// Report the error.</span></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>因为局部变量同时声明了 <code>__strong</code> 和 <code>__autoreleasing</code>，编译器实际上会创建一个修饰符为 <code>__autoreleasing</code> 的临时变量，在消息执行完后再传回 <code>__strong</code> 修饰符的变量。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/26/weak-and-block/">
  <time datetime="2014-12-27T08:42:49.000Z">
    2014-12-26
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/26/weak-and-block/">__weak and __block</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="__block">__block</h2><blockquote>
<p>__block variables live in storage that is shared between the lexical scope of the variable and all blocks and block copies declared or created within the variable’s lexical scope. Thus, the storage will survive the destruction of the stack frame if any copies of the blocks declared within the frame survive beyond the end of the frame (for example, by being enqueued somewhere for later execution). Multiple blocks in a given lexical scope can simultaneously use a shared variable.</p>
</blockquote>
<p><code>__block</code> 是一个存储的修饰词，它定义了在 Block 里的变量应该直接被捕获，而不是 copy。换句话说，<code>__block</code> 让你在 Block 中修改变量：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="built_in">NSString</span> *aString = <span class="string">@"Hey!"</span>; </span><br><span class="line"><span class="keyword">void</span>(^aBlock)() = ^&#123; aString = <span class="string">@"Hello!"</span> &#125;; <span class="comment">// without __block you couldn't modify aString</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, aString); <span class="comment">// Hey!</span></span><br><span class="line">aBlock();</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, aString); <span class="comment">// Hello!</span></span><br></pre></td></tr></table></figure>
<p>在 ARC 中，因为这个变量在 Block 中需要被引用，所以会被自动地 retain。在上面这个例子中，当在 Block 中捕获时 <code>aString</code> 会被发送一个 retain 的消息。</p>
<p>值得注意的是，如果是在 MRC 中，这会出问题。因为你在引用之前没有 retain 。</p>
<h2 id="__weak">__weak</h2><blockquote>
<p>__weak specifies a reference that does not keep the referenced object alive. A weak reference is set to nil when there are no strong references to the object.</p>
</blockquote>
<p>而如果你将它标记为 <code>__weak</code> 的话，这个变量就不会被 retain 。想象一下，如果 block 的生命周期比 block 里面所引用的变量长，会发生什么情况？</p>
<p><a href="http://clang.llvm.org/docs/BlockLanguageSpec.html#objective-c-extensions" target="_blank" rel="external">clang doc</a> ：</p>
<blockquote>
<p>In the Objective-C and Objective-C++ languages, we allow the <code>__weak</code> specifier for <code>__block</code> variables of object type. If garbage collection is not enabled, this qualifier causes these variables to be kept without retain messages being sent. This knowingly leads to <strong>dangling pointers</strong> if the Block (or a copy) outlives the lifetime of this object.</p>
<p>In garbage collected environments, the <code>__weak</code> variable is set to nil when the object it references is collected, as long as the <code>__block</code> variable resides in the heap (either by default or via Block_copy()). The initial Apple implementation does in fact start <code>__block</code> variables on the stack and migrate them to the heap only as a result of a Block_copy() operation.</p>
<p>It is a runtime error to attempt to assign a reference to a stack-based Block into any storage marked <code>__weak</code>, including <code>__weak __block</code> variables.</p>
</blockquote>
<p>如果 Block 比这个对象还要晚才销毁的话，这对象的指针就会变成悬挂指针（dangling pointers）。</p>
<p>因此，<code>__block</code> 可以用来避免 retain cycle （under ARC）这个说法是错误的。</p>
<p>To sum it up,</p>
<p>MRC：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">typeof</span>(<span class="keyword">self</span>) blockSelf = <span class="keyword">self</span>; <span class="comment">//this would retain self in ARC!</span></span><br><span class="line">[<span class="keyword">self</span> methodThatTakesABlock:^ &#123;</span><br><span class="line">    [blockSelf doSomething];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>ARC:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">[<span class="keyword">self</span> methodThatTakesABlock:^ &#123;</span><br><span class="line">    [weakSelf doSomething];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>For getting rid of the retain cycle. :]</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/14/Runtime-2-Object-Class-Meta-Class/">
  <time datetime="2014-12-14T18:45:14.000Z">
    2014-12-14
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/14/Runtime-2-Object-Class-Meta-Class/">Runtime(2) - Object &amp; Class &amp; Meta Class</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Consider the output of following program：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Sark</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Sark</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">BOOL</span> res1 = [(<span class="keyword">id</span>)[<span class="built_in">NSObject</span> class] isKindOfClass:[<span class="built_in">NSObject</span> class]];</span><br><span class="line">        <span class="built_in">BOOL</span> res2 = [(<span class="keyword">id</span>)[<span class="built_in">NSObject</span> class] isMemberOfClass:[<span class="built_in">NSObject</span> class]];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">BOOL</span> res3 = [(<span class="keyword">id</span>)[Sark class] isKindOfClass:[Sark class]];</span><br><span class="line">        <span class="built_in">BOOL</span> res4 = [(<span class="keyword">id</span>)[Sark class] isMemberOfClass:[Sark class]];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d %d"</span>, res1, res2, res3, res4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Output:</strong> </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">04</span>-<span class="number">14</span> <span class="number">09</span>:<span class="number">54</span>:<span class="number">52.651</span> Runtime[<span class="number">14902</span>:<span class="number">354725</span>] <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><code>isKindOf:</code> 和 <code>isMemberOf:</code> 是两个 NSObject 类的 runtime system 函数，通过 runtime 的源码 <em>Object.mm</em> 我们可以一窥它们的实现方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">id</span>)class</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isKindOf:aClass</span><br><span class="line">&#123;</span><br><span class="line">	Class cls;</span><br><span class="line">	<span class="keyword">for</span> (cls = isa; cls; cls = cls-&gt;superclass) </span><br><span class="line">		<span class="keyword">if</span> (cls == (Class)aClass)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isMemberOf:aClass</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> isa == (Class)aClass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上一篇 runtime 介绍了 <code>isa</code> 是指向 <code>Meta Class</code> 的指针。因此：</p>
<ol>
<li><p>对于第一个输出，首先，cls 为 NSObject 的 Meta Class，（因为 isa 指向 对象的 Meta Class），这时候 cls 不等于 NSObject class，结束了吗？ 没有。注意判断是在一个循环里面，cls = cls -&gt; superclass，cls 的 superclass 是什么？ NSObject 的 Meta Class 的 superclass 指向 NSObject 本身。这时候 return YES。</p>
</li>
<li><p>对于第二个输出， isa 指向 Meta Class， aClass 指向 NSObject class，return NO。</p>
</li>
<li><p>对于第三个输出， cls 指向 Sark 的 Meta Class，然后指向 NSObject 的 Meta Class，然后指向 NSObject class，最后指向 nil。return NO。</p>
</li>
<li><p>最后一个， isa 指向 Sark 的 Meta Class，return NO。</p>
</li>
</ol>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/11/Runtime/">
  <time datetime="2014-12-11T18:48:15.000Z">
    2014-12-11
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/11/Runtime/">Runtime</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="What_is_Runtime">What is Runtime</h2><p>一门动态语言，有一些决定工作从编译连接推迟到运行时才被执行。只有编译器是不够的，还需要一个运行时系统 (runtime system) 来执行编译后的代码。这就是 Runtime 存在的意义。</p>
<h2 id="Why_not_function_calling_but_message">Why not function calling but message</h2><p>当你向 receiver 发送一个消息 <code>[receiver message]</code>， 编译器会将其编译为 <code>objc_msgSend(receiver, selector)</code>, 如果消息带有参数，如 <code>[receiver message:arg1]</code>， 则会编译为 <code>objc_msgSend(receiver, selector, arg1)</code>。如果 <code>receiver</code> 找到对应的 <code>selector</code>，那么相当于执行了 <code>receiver</code> 的<code>message</code> 方法，否则，消息或是被转发，或是临时添加对应的实现内容，或者 crash。</p>
<p>看 <code>message.h</code> 是怎么定义的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span><br><span class="line"> * Sends a message with a simple return value to an instance of a class.</span><br><span class="line"> * </span><br><span class="line"> * @param self A pointer to the instance of the class that is to receive the message.</span><br><span class="line"> * @param op The selector of the method that handles the message.</span><br><span class="line"> * @param ... </span><br><span class="line"> *   A variable argument list containing the arguments to the method.</span><br><span class="line"> * </span><br><span class="line"> * @return The return value of the method.</span><br><span class="line"> * </span><br><span class="line"> * @note When it encounters a method call, the compiler generates a call to one of the</span><br><span class="line"> *  functions \c objc_msgSend, \c objc_msgSend_stret, \c objc_msgSendSuper, or \c objc_msgSendSuper_stret.</span><br><span class="line"> *  Messages sent to an object’s superclass (using the \c super keyword) are sent using \c objc_msgSendSuper; </span><br><span class="line"> *  other messages are sent using \c objc_msgSend. Methods that have data structures as return values</span><br><span class="line"> *  are sent using \c objc_msgSendSuper_stret and \c objc_msgSend_stret.</span><br><span class="line"> */</span></span><br><span class="line">OBJC_EXPORT <span class="keyword">id</span> objc_msgSend(<span class="keyword">id</span> <span class="keyword">self</span>, SEL op, ...)</span><br><span class="line">    __OSX_<span class="built_in">AVAILABLE_STARTING</span>(__MAC_10_0, __IPHONE_2_0);</span><br></pre></td></tr></table></figure>
<p>其中第一个参数类型为 <code>id</code>， 第二个参数类型为 <code>SEL</code>。</p>
<h2 id="id">id</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<p>可以知道，<code>id</code> 是一个指向类实例的指针</p>
<h3 id="objc_object">objc_object</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class isa  OBJC_ISA_<span class="built_in">AVAILABILITY</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>而 <code>objc_object</code> 又是一个结构体，包含一个指向 Class 类型的 指针 <code>isa</code></p>
<h3 id="objc_class">objc_class</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_<span class="built_in">AVAILABILITY</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#if !__OBJC2__</span></span><br><span class="line">    Class super_class                                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars                             OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list **methodLists                    OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache *cache                                 OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols                     OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#endif</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>isa</code> 指向所属的 Class， <code>super_class</code> 指向父类。</p>
<p>而在开源的 <em>objc-runtime-new.h</em> 中我们发现在 objc_class 结构体的实现中，objc_class 继承自 objc_object，而且结构体第一项为</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class superclass</span><br></pre></td></tr></table></figure>
<p>我们称之为 <code>Meta Class</code>，又由于 <code>isa</code> 指向所属的 Class，换句话说，<code>isa</code> 指向 <code>Meta Class</code>。</p>
<p>它们的关系如图：</p>
<p><img src="../img/Class&amp;MetaClass.jpg" alt=""></p>
<h2 id="SEL">SEL</h2><p><code>objc.h</code> 中定义了这种数据类型：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents a method selector.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</span><br></pre></td></tr></table></figure>
<p>在 <code>runtime.h</code> 中， <code>/* Working with Selectors */</code>下面有这样四个方法：</p>
<ul>
<li>OBJC_EXPORT const char *sel_getName(SEL sel)<br>  <strong>__OSX_AVAILABLE_STARTING(</strong>MAC_10_0, __IPHONE_2_0);</li>
</ul>
<p>返回一个 char 类型，即 Selector 的名字</p>
<ul>
<li>OBJC_EXPORT SEL sel_getUid(const char *str)<br>  <strong>__OSX_AVAILABLE_STARTING(</strong>MAC_10_0, __IPHONE_2_0);</li>
</ul>
<p>通过传入一个 UID，返回一个特定的 SEL</p>
<ul>
<li>OBJC_EXPORT SEL sel_registerName(const char *str)<br>  <strong>__OSX_AVAILABLE_STARTING(</strong>MAC_10_0, __IPHONE_2_0);</li>
</ul>
<p>通过一个 char 类型注册一个 SEL</p>
<ul>
<li>OBJC_EXPORT BOOL sel_isEqual(SEL lhs, SEL rhs)<br>   <strong>__OSX_AVAILABLE_STARTING(</strong>MAC_10_5, __IPHONE_2_0);</li>
</ul>
<p>传入两个 SEL 判断他们是否相等</p>
<p>可以看到，他们都是与 Selector 相关的 Runtime 函数。</p>
<h2 id="Message_Forwarding">Message Forwarding</h2><p><code>forwardInvocation:</code> 方法通常用来将消息转发给另一个对象。<br>通过实现 <code>forwardInvocation:</code> 方法赋予消息一个默认的响应者，并且可以避免一些错误的产生。</p>
<p>To see the scope and intent of forwarding, imagine the following scenarios: Suppose, first, that you’re designing an object that can respond to a message called negotiate, and you want its response to include the response of another kind of object. You could accomplish this easily by passing a negotiate message to the other object somewhere in the body of the negotiate method you implement.</p>
<p>Take this a step further, and suppose that you want your object’s response to a negotiate message to be exactly the response implemented in another class. One way to accomplish this would be to make your class inherit the method from the other class. However, it might not be possible to arrange things this way. There may be good reasons why your class and the class that implements negotiate are in different branches of the inheritance hierarchy.</p>
<p>Even if your class can’t inherit the negotiate method, you can still “borrow” it by implementing a version of the method that simply passes the message on to an instance of the other class:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)negotiate</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( [someOtherObject respondsTo:<span class="keyword">@selector</span>(negotiate)] )</span><br><span class="line">        <span class="keyword">return</span> [someOtherObject negotiate];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>换句话说，如果这个对象不能响应 <code>negotiate</code> 这个消息，你可以把它<strong>扔</strong>给其他类然后让它决定是否响应。</p>
<p>When an object can’t respond to a message because it doesn’t have a method matching the selector in the message, the runtime system informs the object by sending it a forwardInvocation: message. Every object inherits a forwardInvocation: method from the NSObject class. However, NSObject’s version of the method simply invokes doesNotRecognizeSelector:. By overriding NSObject’s version and implementing your own, you can take advantage of the opportunity that the forwardInvocation: message provides to forward messages to other objects.</p>
<p>当对象由于没有与选择器相匹配的方法时，runtime system 会向其发送一个 <code>forwardInvocation:</code> 消息。每一个对象由于都继承自 NSObject 类从而继承了 NSObject 的 <code>forwardInvocation:</code> 方法。但是，NSObject 只是简单地调用了 <code>doesNotRecognizeSelector:</code> 这个方法。你还需要重载这个方法然后实现自己的 <code>forwardInvocation:</code> 方法从而把消息转发给其他对象。</p>
<p>这个 <code>forwardInvocation:</code> 方法需要做两样的事情：</p>
<ul>
<li>决定消息应该被转发到哪</li>
<li>把原始的参数一并转发出去</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([someOtherObject respondsToSelector:</span><br><span class="line">            [anInvocation selector]])</span><br><span class="line">        [anInvocation invokeWithTarget:someOtherObject];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息返回的值会被传递到最原始的发送者，包括 <code>ids</code>， <code>structures</code> 还有 <code>double-precision floating-point numbers</code>。 </p>
<p>这个 <code>forwardInvocation</code> 方法可以被看成是 unrecognized messages 的转发中心，或者是一个转移枢纽，将所有消息都传递到同一个地方。它可以将消息传递到另一个接受者，也可以把那些没有响应者的<strong>消化</strong>掉，来避免 no response。这这机制让互相关联的对象在设计上提供了无限的可能。</p>
<h2 id="Forwarding_and_Multiple_Inheritance">Forwarding and Multiple Inheritance</h2><p><img src="../img/forwarding.png" alt=""></p>
<p>首先，<code>Warrior</code> 和 <code>Diplomat</code> 没有继承关系，如果你向 <code>Warrior</code> 发送一个 <code>negotiate</code> 消息， <code>Warrior</code> 不能响应这个方法，并把它转发给 <code>Diplomat</code> 类，这看起来就像 <code>Warrior</code> 能响应 <code>negotiate</code> 消息一样。（尽管实际上是 Diplomat 响应的）</p>
<p>这个例子就像 <code>Warrior</code> 类是继承自 <code>Diplomat</code> 的一样。</p>
<p>消息转发给我们提供了像多重继承一样的特性。但是，它们之间仍然有相当大的区别：多重继承将不同的东西组合到一个臃肿的对象中，而消息转发，则将不同的东西细分到各自所负责的对象中，这使得对象之间的关系由于消息转发机制而透明清晰。</p>
<h2 id="Surrogate_Objects">Surrogate Objects</h2><p>Forwarding not only mimics multiple inheritance, it also makes it possible to develop lightweight objects that represent or “cover” more substantial objects. The surrogate stands in for the other object and funnels messages to it.</p>
<p>The proxy discussed in “Remote Messaging” in The Objective-C Programming Language is such a surrogate. A proxy takes care of the administrative details of forwarding messages to a remote receiver, making sure argument values are copied and retrieved across the connection, and so on. But it doesn’t attempt to do much else; it doesn’t duplicate the functionality of the remote object but simply gives the remote object a local address, a place where it can receive messages in another application.</p>
<p>Other kinds of surrogate objects are also possible. Suppose, for example, that you have an object that manipulates a lot of data—perhaps it creates a complicated image or reads the contents of a file on disk. Setting this object up could be time-consuming, so you prefer to do it lazily—when it’s really needed or when system resources are temporarily idle. At the same time, you need at least a placeholder for this object in order for the other objects in the application to function properly.</p>
<p>In this circumstance, you could initially create, not the full-fledged object, but a lightweight surrogate for it. This object could do some things on its own, such as answer questions about the data, but mostly it would just hold a place for the larger object and, when the time came, forward messages to it. When the surrogate’s forwardInvocation: method first receives a message destined for the other object, it would ensure that the object existed and would create it if it didn’t. All messages for the larger object go through the surrogate, so, as far as the rest of the program is concerned, the surrogate and the larger object would be the same.</p>
<h2 id="Forwarding_and_Inheritance">Forwarding and Inheritance</h2><p>尽管消息转发很像继承，但是 <code>NSObject</code> 还是不会将它们混淆的。看这个例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( [aWarrior respondsToSelector:<span class="keyword">@selector</span>(negotiate)] )</span><br><span class="line">	...</span><br><span class="line"><span class="comment">///return YES  (if Warrior inherit from Diplomat)</span></span><br><span class="line"><span class="comment">///return NO   (if Warrior just forward message to Diplomat as above)</span></span><br></pre></td></tr></table></figure>
<p>如果你确实想瞒天过海的话，你需要重新实现 <code>respondsToSelector:</code> 和 <code>isKindOfClass:</code> 方法像下面那样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)respondsToSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( [<span class="keyword">super</span> respondsToSelector:aSelector] )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Here, test whether the aSelector message can     *</span><br><span class="line">         * be forwarded to another object and whether that  *</span><br><span class="line">         * object can respond to it. Return YES if it can.  */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除此之外，<code>instancesRespondToSelector:</code> 方法也应该实现转发算法。如果遵从协议，那么 <code>conformsToProtocol:</code> 方法也应该做同样的事情。同样的，如果一个对象转发它接受的任何远程消息，它得给出一个 <code>methodSignatureForSelector:</code> 来返回准确的方法描述，这个方法会最终响应被转发的消息。比如一个对象能给它的替代者对象转发消息，它需要像下面这样实现 <code>methodSignatureForSelector:</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMethodSignature</span>*)methodSignatureForSelector:(SEL)selector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span>* signature = [<span class="keyword">super</span> methodSignatureForSelector:selector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">       signature = [surrogate methodSignatureForSelector:selector];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>考虑将这些转发消息的代码单独封装起来，当你需要使用它们的时候，直接调用它们就可以了。</p>
<blockquote>
<p>Note:  This is an advanced technique, suitable only for situations where no other solution is possible. It is not intended as a replacement for inheritance. If you must make use of this technique, make sure you fully understand the behavior of the class doing the forwarding and the class you’re forwarding to.</p>
</blockquote>
<p>最后，慎用黑魔法。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">Zigii Wong</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>