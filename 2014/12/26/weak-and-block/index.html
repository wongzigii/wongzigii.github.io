<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="__block __block variables live in storage that is shared between the lexical scope of the variable and all blocks and block copies declared or created within the variable’s lexical scope. Thus, the st">
<meta property="og:type" content="article">
<meta property="og:title" content="__weak and __block">
<meta property="og:url" content="http://wongzigii.github.io/2014/12/26/weak-and-block/index.html">
<meta property="og:site_name" content="Silver Bullet">
<meta property="og:description" content="__block __block variables live in storage that is shared between the lexical scope of the variable and all blocks and block copies declared or created within the variable’s lexical scope. Thus, the st">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-05-31T07:55:31.704Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="__weak and __block">
<meta name="twitter:description" content="__block __block variables live in storage that is shared between the lexical scope of the variable and all blocks and block copies declared or created within the variable’s lexical scope. Thus, the st">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>__weak and __block</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2015/01/10/Property-declarations/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2014/12/14/Runtime-2-Object-Class-Meta-Class/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://wongzigii.github.io/2014/12/26/weak-and-block/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&text=__weak and __block"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&is_video=false&description=__weak and __block"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=__weak and __block&body=Check out this article: http://wongzigii.github.io/2014/12/26/weak-and-block/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&name=__weak and __block&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#block"><span class="toc-number">1.</span> <span class="toc-text">__block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weak"><span class="toc-number">2.</span> <span class="toc-text">__weak</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        __weak and __block
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Silver Bullet</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2014-12-26T15:42:49.000Z" itemprop="datePublished">2014-12-26</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="block"><a href="#block" class="headerlink" title="__block"></a>__block</h2><blockquote>
<p>__block variables live in storage that is shared between the lexical scope of the variable and all blocks and block copies declared or created within the variable’s lexical scope. Thus, the storage will survive the destruction of the stack frame if any copies of the blocks declared within the frame survive beyond the end of the frame (for example, by being enqueued somewhere for later execution). Multiple blocks in a given lexical scope can simultaneously use a shared variable.</p>
</blockquote>
<p><code>__block</code> 是一个存储的修饰词，它定义了在 Block 里的变量应该直接被捕获，而不是 copy。换句话说，<code>__block</code> 让你在 Block 中修改变量：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="built_in">NSString</span> *aString = <span class="string">@"Hey!"</span>;</span><br><span class="line"><span class="keyword">void</span>(^aBlock)() = ^&#123; aString = <span class="string">@"Hello!"</span> &#125;; <span class="comment">// without __block you couldn't modify aString</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, aString); <span class="comment">// Hey!</span></span><br><span class="line">aBlock();</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, aString); <span class="comment">// Hello!</span></span><br></pre></td></tr></table></figure>
<p>在 ARC 中，因为这个变量在 Block 中需要被引用，所以会被自动地 retain。在上面这个例子中，当在 Block 中捕获时 <code>aString</code> 会被发送一个 retain 的消息。</p>
<p>值得注意的是，如果是在 MRC 中，这会出问题。因为你在引用之前没有 retain 。</p>
<h2 id="weak"><a href="#weak" class="headerlink" title="__weak"></a>__weak</h2><blockquote>
<p>__weak specifies a reference that does not keep the referenced object alive. A weak reference is set to nil when there are no strong references to the object.</p>
</blockquote>
<p>而如果你将它标记为 <code>__weak</code> 的话，这个变量就不会被 retain 。想象一下，如果 block 的生命周期比 block 里面所引用的变量长，会发生什么情况？</p>
<p><a href="http://clang.llvm.org/docs/BlockLanguageSpec.html#objective-c-extensions" target="_blank" rel="noopener">clang doc</a> ：</p>
<blockquote>
<p>In the Objective-C and Objective-C++ languages, we allow the <code>__weak</code> specifier for <code>__block</code> variables of object type. If garbage collection is not enabled, this qualifier causes these variables to be kept without retain messages being sent. This knowingly leads to <strong>dangling pointers</strong> if the Block (or a copy) outlives the lifetime of this object.</p>
<p>In garbage collected environments, the <code>__weak</code> variable is set to nil when the object it references is collected, as long as the <code>__block</code> variable resides in the heap (either by default or via Block_copy()). The initial Apple implementation does in fact start <code>__block</code> variables on the stack and migrate them to the heap only as a result of a Block_copy() operation.</p>
<p>It is a runtime error to attempt to assign a reference to a stack-based Block into any storage marked <code>__weak</code>, including <code>__weak __block</code> variables.</p>
</blockquote>
<p>如果 Block 比这个对象还要晚才销毁的话，这对象的指针就会变成悬挂指针（dangling pointers）。</p>
<p>因此，<code>__block</code> 可以用来避免 ARC 下的 <code>retain cycle</code> 这个说法是错误的。</p>
<p>To sum it up,</p>
<p>MRC：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">typeof</span>(<span class="keyword">self</span>) blockSelf = <span class="keyword">self</span>; <span class="comment">//this would retain self in ARC!</span></span><br><span class="line">[<span class="keyword">self</span> methodThatTakesABlock:^ &#123;</span><br><span class="line">    [blockSelf doSomething];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>ARC:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">[<span class="keyword">self</span> methodThatTakesABlock:^ &#123;</span><br><span class="line">    [weakSelf doSomething];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#block"><span class="toc-number">1.</span> <span class="toc-text">__block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weak"><span class="toc-number">2.</span> <span class="toc-text">__weak</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://wongzigii.github.io/2014/12/26/weak-and-block/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&text=__weak and __block"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&is_video=false&description=__weak and __block"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=__weak and __block&body=Check out this article: http://wongzigii.github.io/2014/12/26/weak-and-block/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&title=__weak and __block"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://wongzigii.github.io/2014/12/26/weak-and-block/&name=__weak and __block&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Zigii Wong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
