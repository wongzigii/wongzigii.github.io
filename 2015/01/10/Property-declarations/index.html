<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="LLVM 在 3.1 以后引入了四个 Lifetime Qualifiers，它们分别是 __autoreleasing，__strong，__unsafe_untained 还有 __weak。其中 __weak 只在 ARC 下才存在，而其他三个仍然可以在 MRC 下看到它们。  __strong is the default. An object remains “alive” as lon">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM Lifetime Qualifiers">
<meta property="og:url" content="http://wongzigii.github.io/2015/01/10/Property-declarations/index.html">
<meta property="og:site_name" content="Silver Bullet">
<meta property="og:description" content="LLVM 在 3.1 以后引入了四个 Lifetime Qualifiers，它们分别是 __autoreleasing，__strong，__unsafe_untained 还有 __weak。其中 __weak 只在 ARC 下才存在，而其他三个仍然可以在 MRC 下看到它们。  __strong is the default. An object remains “alive” as lon">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-05-30T04:53:49.681Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LLVM Lifetime Qualifiers">
<meta name="twitter:description" content="LLVM 在 3.1 以后引入了四个 Lifetime Qualifiers，它们分别是 __autoreleasing，__strong，__unsafe_untained 还有 __weak。其中 __weak 只在 ARC 下才存在，而其他三个仍然可以在 MRC 下看到它们。  __strong is the default. An object remains “alive” as lon">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>LLVM Lifetime Qualifiers</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2015/02/01/Initialize-vs.-Load/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2014/12/26/weak-and-block/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://wongzigii.github.io/2015/01/10/Property-declarations/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&text=LLVM Lifetime Qualifiers"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&is_video=false&description=LLVM Lifetime Qualifiers"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=LLVM Lifetime Qualifiers&body=Check out this article: http://wongzigii.github.io/2015/01/10/Property-declarations/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&name=LLVM Lifetime Qualifiers&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#strong"><span class="toc-number">1.</span> <span class="toc-text">__strong</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weak-and-unsafe-unretained"><span class="toc-number">2.</span> <span class="toc-text">__weak and __unsafe_unretained</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#autoreleasing"><span class="toc-number">3.</span> <span class="toc-text">__autoreleasing</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        LLVM Lifetime Qualifiers
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Silver Bullet</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2015-01-10T14:55:06.000Z" itemprop="datePublished">2015-01-10</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>LLVM 在 3.1 以后引入了四个 <code>Lifetime Qualifiers</code>，它们分别是 <code>__autoreleasing</code>，<code>__strong</code>，<code>__unsafe_untained</code> 还有 <code>__weak</code>。其中 __weak 只在 ARC 下才存在，而其他三个仍然可以在 MRC 下看到它们。</p>
<ul>
<li>__strong is the default. An object remains “alive” as long as there is a strong pointer to it.</li>
<li>__weak specifies a reference that does not keep the referenced object alive. A weak reference is set to nil when there are no strong references to the object.</li>
<li>__unsafe_unretained specifies a reference that does not keep the referenced object alive and is not set to nil when there are no strong references to the object. If the object it references is deallocated, the pointer is left dangling.</li>
<li>__autoreleasing is used to denote arguments that are passed by reference (id *) and are autoreleased on return.</li>
</ul>
<h2 id="strong"><a href="#strong" class="headerlink" title="__strong"></a><code>__strong</code></h2><p> 在 ARC 下，所有的指针都会默认为 <code>__strong</code>. 也就是说当指针指向一个对象时，这个对象的 retain count 就会加 1。当超出作用域或者指针被赋值后，编译器会自动为 <code>__strong</code> 修饰的对象指针添加 release。</p>
<h2 id="weak-and-unsafe-unretained"><a href="#weak-and-unsafe-unretained" class="headerlink" title="__weak and __unsafe_unretained"></a><code>__weak</code> and <code>__unsafe_unretained</code></h2><p> 为了解决这个问题，<code>__unsafe_unretained</code> 和 <code>__weak</code> 诞生了。最常见的是当你声明一个 delegate 的时候，你需要将它的类型声明为 <code>weak</code> 或者 <code>unsafe_unretained</code> (assign 在这里相当于 <code>unsafe_unretained</code>)。在实例变量前面标记为 <code>__weak</code> 或者 <code>__unsafe_unretained</code> 。这样，delegate 的实例变量仍然指向第一个对象，但是不会被 retain，从而避免了 retain cycle。</p>
<p> 除了 delegate 之外，也可以用来避免其他代码的 retain cycle。而 Leaks Instrument 里面已经可以检查是否有 retain cycle 所导致的 memory leak 了。</p>
<p>###<code>__unsafe_unretained</code> 和 <code>__weak</code> 的区别</p>
<p>对于 <code>__weak</code>，当对象销毁后指针会被设为 nil， 这个做法使得指针的使用更安全。而正如它的名字那样，<code>__unsafe_unretained</code> 仍然会指向销毁对象的地址，顾名思义这是 unsafe 的。</p>
<p>值得注意的是：</p>
<blockquote>
<p>__weak is only supported for iOS 5.0 and Lion as deployment targets.</p>
</blockquote>
<h2 id="autoreleasing"><a href="#autoreleasing" class="headerlink" title="__autoreleasing"></a><code>__autoreleasing</code></h2><p>将对象指向自动释放池，编译器会自动计算 retain count，并且释放内存。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">id</span>)array </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> [[<span class="built_in">NSMutableArray</span> alloc] init]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我发现这个修饰符一般用在方法里面，因为你需要在消息的作用域里拥有这个对象，但是你又不能在消息执行完之前把它释放掉，因此把它交给 autoreleasepool，在消息执行完后，再由自动释放池释放。</p>
<p><code>Variable Qualifiers</code> 的格式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyClass * __<span class="keyword">weak</span> myWeakReference;</span><br><span class="line">MyClass * __<span class="keyword">unsafe_unretained</span> myUnsafeReference;</span><br></pre></td></tr></table></figure>
<p>注意：如果你这像下面那样使用 <code>__weak</code>，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * __<span class="keyword">weak</span> string = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"First Name: %@"</span>, [<span class="keyword">self</span> firstName]];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"string: %@"</span>, string);</span><br></pre></td></tr></table></figure>
<p>编译器会警告你：<code>Assigning retained object to weak variable; object will be released after assignment.</code> 当你 init 完这个对象后，由于前面是 __weak 修饰符，<code>string</code> 会马上被 dealloc，因为这时候没有其他强引用指向这个对象。</p>
<p>还有一个需要注意的地方，就是将对象传递给消息：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"><span class="built_in">BOOL</span> OK = [myObject performOperationWithError:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (!OK) &#123;</span><br><span class="line">    <span class="comment">// Report the error.</span></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>实际上，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> * __<span class="keyword">strong</span> e;</span><br></pre></td></tr></table></figure>
<p>并且（上面说过的作为参数会加一个 <code>__autoreleasing</code> 修饰符）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">BOOL</span>)performOperationWithError:(<span class="built_in">NSError</span> * __autoreleasing *)error;</span><br></pre></td></tr></table></figure>
<p>所以编译器实际上会重写成这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> * __<span class="keyword">strong</span> error;</span><br><span class="line"><span class="built_in">NSError</span> * __autoreleasing tmp = error;</span><br><span class="line"><span class="built_in">BOOL</span> OK = [myObject performOperationWithError:&amp;tmp];</span><br><span class="line">error = tmp;</span><br><span class="line"><span class="keyword">if</span> (!OK) &#123;</span><br><span class="line">    <span class="comment">// Report the error.</span></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>因为局部变量同时声明了 <code>__strong</code> 和 <code>__autoreleasing</code>，编译器实际上会创建一个修饰符为 <code>__autoreleasing</code> 的临时变量，在消息执行完后再传回 <code>__strong</code> 修饰符的变量。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#strong"><span class="toc-number">1.</span> <span class="toc-text">__strong</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weak-and-unsafe-unretained"><span class="toc-number">2.</span> <span class="toc-text">__weak and __unsafe_unretained</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#autoreleasing"><span class="toc-number">3.</span> <span class="toc-text">__autoreleasing</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://wongzigii.github.io/2015/01/10/Property-declarations/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&text=LLVM Lifetime Qualifiers"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&is_video=false&description=LLVM Lifetime Qualifiers"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=LLVM Lifetime Qualifiers&body=Check out this article: http://wongzigii.github.io/2015/01/10/Property-declarations/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&title=LLVM Lifetime Qualifiers"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://wongzigii.github.io/2015/01/10/Property-declarations/&name=LLVM Lifetime Qualifiers&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Zigii Wong
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects_url">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
